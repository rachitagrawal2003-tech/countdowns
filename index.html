<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Kitten & Daddy üíñ (Live + AI)</title>
  <style>
    /* =========================================
       EXISTING STYLES (PRESERVED 100%)
       ========================================= */
    /* Bokeh Background Lights */
    #bokeh-container {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        z-index: -1; pointer-events: none; overflow: hidden;
    }
    .bokeh-orb {
        position: absolute;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.15);
        box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
        bottom: -100px;
        animation: floatUpBokeh linear infinite;
    }
    @keyframes floatUpBokeh {
        to { transform: translateY(-120vh) rotate(360deg); }
    }
    /* Diamond Shimmer Effect */
    .card, .fun-card, .nav-bar {
        position: relative;
        overflow: hidden; /* Keeps the shine inside the card */
    }
    
    .card::after, .fun-card::after {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 50%;
        height: 100%;
        /* The Shine Beam */
        background: linear-gradient(
            to right, 
            rgba(255,255,255,0) 0%, 
            rgba(255,255,255,0.4) 50%, 
            rgba(255,255,255,0) 100%
        );
        transform: skewX(-25deg);
        pointer-events: none;
        /* Run every 6 seconds */
        animation: glassShine 6s infinite;
    }

    @keyframes glassShine {
        0% { left: -100%; }
        20% { left: 200%; } /* Fast swipe */
        100% { left: 200%; } /* Wait */
    }
    /* =========================================
       1. THEME SYSTEM (UPDATED FOR VISIBILITY)
       ========================================= */
    :root {
      /* --- DEFAULT: Romantic Glow (Day) --- */
      --bg-gradient: linear-gradient(135deg, #ee9ca7 0%, #ffdde1 100%);
      --text-main: #864e66;
      --text-sub: #b58399;
      --heading-color: #ff5e89;
      
      /* Glassy Cards */
      --card-bg: rgba(255, 255, 255, 0.65);
      --card-border: rgba(255, 255, 255, 0.8);
      --card-shadow: 0 8px 32px 0 rgba(255, 94, 137, 0.35);
      
      /* NEW: High Contrast Shimmer for Light Mode (Rose Gold) */
      --shimmer-color: rgba(255, 255, 255, 0.95); 
      
      --nav-bg: rgba(255, 255, 255, 0.8);
      --nav-border: rgba(255, 255, 255, 0.5);
      --nav-active: #ff5e89;
      --nav-inactive: #b58399;
      
      --btn-bg: linear-gradient(45deg, #ff9a9e, #fad0c4);
      --btn-text: #fff;
      
      --accent-green: #88d8b0;
      --accent-red: #ff6b6b;
      --modal-bg: rgba(255, 255, 255, 0.9);
      --envelope-front: #ff7da5;
      --envelope-back: #ffffff;
    }

    [data-theme="dark"] {
      /* --- DARK ROMANTIC: Midnight Dream --- */
      --bg-gradient: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
      --text-main: #e0c3fc;
      --text-sub: #a79db8;
      --heading-color: #d8b4fe;
      
      /* Dark Glass */
      --card-bg: rgba(20, 20, 40, 0.6); 
      --card-border: rgba(255, 255, 255, 0.1);
      --card-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
      
      /* NEW: Subtle Shimmer for Dark Mode */
      --shimmer-color: rgba(255, 255, 255, 0.15);
      
      --nav-bg: rgba(20, 20, 40, 0.8);
      --nav-border: rgba(255, 255, 255, 0.1);
      --nav-active: #c084fc;
      
      --btn-bg: linear-gradient(45deg, #7c3aed, #a78bfa);
      --btn-text: #ffffff;
      --modal-bg: rgba(30, 30, 50, 0.95);
    }

    /* UPDATED ANIMATIONS (The "Lively" Effect) */
    @keyframes floatCard {
      0% { transform: translateY(0px); }
      50% { transform: translateY(-6px); } /* Gentle float up */
      100% { transform: translateY(0px); }
    }

    /* Apply Float to Cards */
    .card, .fun-card {
      /* Existing styles... */
      animation: floatCard 6s ease-in-out infinite; /* Everything breathes */
    }
    
    /* Offset animations so they don't all move at once */
    .card:nth-child(odd) { animation-delay: 1s; }
    .fun-card:nth-child(even) { animation-delay: 2s; }

    /* UPDATED SHIMMER (Uses the new variable) */
    .card::after, .fun-card::after {
        content: ''; position: absolute; top: 0; left: -150%; width: 100%; height: 100%;
        background: linear-gradient(
            to right, 
            transparent 0%, 
            var(--shimmer-color) 50%, 
            transparent 100%
        );
        transform: skewX(-25deg); pointer-events: none;
        animation: glassShine 5s infinite; /* Faster shine */
    }

    body[data-mode="period"] {
      /* --- COMFORT: Warm Embrace --- */
      --bg-gradient: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%);
      --text-main: #5c3a3a;
      --heading-color: #ff6b6b;
      
      /* Warm Glass */
      --card-bg: rgba(255, 245, 245, 0.7);
      --card-border: rgba(255, 200, 200, 0.6);
      --card-shadow: 0 8px 32px 0 rgba(255, 100, 100, 0.2);
      
      --btn-bg: linear-gradient(45deg, #ff758c, #ff7eb3);
      --nav-bg: rgba(255, 245, 245, 0.9);
    }

    /* =========================================
       2. GLOBAL STYLES
       ========================================= */
    body {
      font-family: "Poppins", system-ui, -apple-system, sans-serif;
      background: var(--bg-gradient);
      background-attachment: fixed;
      /* key change: Zoom in so we can pan around */
      background-size: 400% 400%; 
      color: var(--text-main);
      margin: 0;
      padding-bottom: 110px;
      text-align: center;
      overflow-x: hidden;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      /* The Magic Animation */
      animation: auroraGradient 15s ease infinite;
    }

    @keyframes auroraGradient {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    /* Add Text Glow */
    h1, h2, h3, .emoji {
        text-shadow: 0 0 20px rgba(255,255,255,0.5);
    }
    /* =========================================
       3. NAVIGATION BAR (TAB SYSTEM)
       ========================================= */
    .nav-bar {
      position: fixed; bottom: 0; left: 0; width: 100%; height: 70px;
      background: var(--nav-bg); backdrop-filter: blur(10px);
      border-top: 1px solid var(--nav-border);
      display: flex; justify-content: space-around; align-items: center;
      z-index: 5000; box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
    }
    .nav-item {
      background: none; border: none; display: flex; flex-direction: column;
      align-items: center; justify-content: center; color: var(--nav-inactive);
      transition: all 0.3s; cursor: pointer; flex: 1; padding: 5px 0;
    }
    .nav-item.active { color: var(--nav-active); transform: translateY(-5px); }
    .nav-icon { font-size: 1.5rem; margin-bottom: 2px; }
    .nav-label { font-size: 0.7rem; font-weight: 600; }

    /* =========================================
       4. SECTIONS & LAYOUT
       ========================================= */
    .tab-section { display: none; padding: 10px; animation: fadeIn 0.4s ease; }
    .tab-section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Cards */
    .countdowns { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; padding: 10px; }
    .card {
      background-color: var(--card-bg); border: 1px solid var(--card-border);
      border-radius: 18px; box-shadow: 0 4px 12px var(--card-shadow);
      width: 45%; min-width: 150px; max-width: 220px; padding: 15px;
      transition: transform 0.25s ease, background-color 0.5s; cursor: pointer;
    }
    .card:active { transform: scale(0.98); }
    img.card-img { width: 100%; border-radius: 10px; margin-top: 8px; display: block; }
    
    .fun-card {
      margin: 20px auto; max-width: 340px; background: var(--card-bg);
      padding: 20px; border-radius: 20px; border: 2px solid var(--card-border);
      box-shadow: 0 4px 15px var(--card-shadow);
    }

    /* Buttons */
    button, .interactive-btn {
      background-color: var(--btn-bg); color: var(--btn-text);
      border: none; padding: 12px 24px; border-radius: 50px;
      font-weight: bold; cursor: pointer; transition: transform 0.2s;
    }
    button:active { transform: scale(0.95); }

    /* Header Image */
    .header-image img { width: 100%; max-height: 200px; object-fit: cover; border-radius: 0 0 20px 20px; }
    
    /* VIBE CHECKER STYLES */
    #vibeOutput {
        min-height: 50px;
        background: rgba(255, 255, 255, 0.4);
        padding: 10px;
        border-radius: 10px;
        margin-top: 15px;
        text-align: center;
        font-style: italic;
    }

    /* LIVE CHAT STYLES */
    #chat-messages {
        height: 250px;
        overflow-y: auto;
        background: rgba(255,255,255,0.3);
        border-radius: 15px;
        padding: 10px;
        margin-bottom: 10px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        scroll-behavior: smooth;
    }
    .chat-msg {
        padding: 8px 12px;
        border-radius: 15px;
        max-width: 80%;
        word-wrap: break-word;
        font-size: 0.9rem;
        animation: fadeIn 0.3s;
    }
    .msg-self {
        background: var(--btn-bg);
        color: white;
        align-self: flex-end;
        border-bottom-right-radius: 2px;
    }
    .msg-other {
        background: white;
        color: var(--text-main);
        align-self: flex-start;
        border-bottom-left-radius: 2px;
        border: 1px solid var(--card-border);
    }
    .chat-input-group {
        display: flex;
        gap: 5px;
    }
    #chatInput {
        flex: 1;
        padding: 10px;
        border-radius: 20px;
        border: 1px solid var(--card-border);
        outline: none;
    }

    /* =========================================
       5. COMFORT ZONE
       ========================================= */
    .comfort-header {
      background: #ffe0b2; padding: 15px; border-radius: 15px; margin-bottom: 20px;
      color: #5d4037; display: flex; align-items: center; justify-content: space-between;
    }
    .heat-pad-btn {
      width: 150px; height: 150px; border-radius: 50%;
      background: radial-gradient(circle, #ffab91, #ff7043);
      color: white; font-size: 1.2rem; font-weight: bold;
      border: none; margin: 20px auto; display: flex; align-items: center; justify-content: center;
      box-shadow: 0 0 20px rgba(255, 112, 67, 0.4);
      transition: transform 0.1s; cursor: pointer; touch-action: none;
    }
    .heat-pad-btn.active { animation: pulseHeat 0.8s infinite; }
    @keyframes pulseHeat { 0% { transform: scale(1); box-shadow: 0 0 20px rgba(255, 112, 67, 0.4); } 50% { transform: scale(1.1); box-shadow: 0 0 40px rgba(255, 112, 67, 0.8); } 100% { transform: scale(1); box-shadow: 0 0 20px rgba(255, 112, 67, 0.4); } }
    
    .choco-bar {
      width: 200px; height: 100px; background: #5d4037;
      margin: 20px auto; border-radius: 5px; position: relative; cursor: pointer;
      display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(2, 1fr); gap: 2px;
      box-shadow: 5px 5px 0px rgba(0,0,0,0.1); transition: opacity 0.3s;
    }
    .choco-piece { background: #795548; border-radius: 2px; border-top: 2px solid #8d6e63; border-left: 2px solid #8d6e63; }
    
    /* =========================================
       6. GALLERY (NOTEBOOK STYLE)
       ========================================= */
    #gallery-container {
      position: relative; 
      width: 100%; 
      height: 80vh; 
      display: flex; 
      align-items: center; 
      justify-content: center;
      overflow: hidden;
    }
    .book-scene {
        width: 300px;
        height: 420px;
        perspective: 1500px;
    }
    .book {
        width: 100%;
        height: 100%;
        position: relative;
        transform-style: preserve-3d;
    }
    .page {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
        transform-origin: left center;
        transition: transform 0.8s cubic-bezier(0.645, 0.045, 0.355, 1);
        transform-style: preserve-3d;
        cursor: pointer;
        border-radius: 5px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        background: #fff; /* Paper color */
    }
    .page-face {
        position: absolute;
        width: 100%;
        height: 100%;
        backface-visibility: hidden;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 15px;
        box-sizing: border-box;
        background-image: linear-gradient(to right, #e3e3e3 0%, #fff 5%, #fff 100%); /* spine shadow */
        border: 1px solid #ddd;
    }
    .page-back {
        transform: rotateY(180deg);
        background-image: linear-gradient(to left, #e3e3e3 0%, #fff 5%, #fff 100%);
    }
    .page.flipped {
        transform: rotateY(-180deg);
    }
    /* Polaroid style internal photo */
    .photo-frame {
        background: white;
        padding: 10px 10px 40px 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        transform: rotate(-2deg);
        width: 90%;
        transition: transform 0.3s;
    }
    .photo-frame img {
        width: 100%;
        height: auto;
        display: block;
        border: 1px solid #eee;
    }
    .page-number {
        position: absolute;
        bottom: 10px;
        font-size: 0.8rem;
        color: #888;
    }

    /* =========================================
       7. FULL SCREEN GAME OVERLAYS
       ========================================= */
    .game-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: black; z-index: 6000; display: none; touch-action: none;
    }
    .game-overlay.active { display: block; animation: fadeIn 0.3s; }
    .overlay-close {
      position: absolute; top: 20px; right: 20px; z-index: 6001;
      background: rgba(255,255,255,0.3); color: white; border: none;
      width: 40px; height: 40px; border-radius: 50%; font-size: 1.5rem;
    }
    canvas.fs-canvas { width: 100%; height: 100%; display: block; }
    
    .lantern {
      position: absolute; width: 30px; height: 40px; background: linear-gradient(#ffeb3b, #ff9800);
      border-radius: 5px; opacity: 0.9; box-shadow: 0 0 20px orange;
      animation: floatUp linear forwards; pointer-events: none;
    }
    @keyframes floatUp { to { transform: translateY(-110vh); opacity: 0; } }

    /* =========================================
       8. FLOATING HEARTS & RAIN CSS
       ========================================= */
    .heart-bg {
        position: fixed; bottom: -20px; font-size: 20px;
        animation: floatUp 5s linear; opacity: 0.6; z-index: -1; pointer-events: none;
    }
    
    /* Soft Rain Overlay */
    .rain-container {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      pointer-events: none; z-index: 9998; display: none;
    }
    .rain-container.active { display: block; }
    .rain-drop {
      position: absolute; bottom: 100%; width: 2px; height: 15px; 
      background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(137, 196, 244, 0.8)); 
      animation: fall linear infinite;
    }
    @keyframes fall { to { transform: translateY(110vh); } }

    /* =========================================
       9. EXISTING COMPONENT STYLES
       ========================================= */
    /* Envelope */
    .envelope-container { transition: transform 0.8s; }
    .open .envelope-container { transform: rotateY(180deg); }
    .envelope-front { background: var(--envelope-front); }
    .envelope-back { background: var(--envelope-back); border-color: var(--envelope-front); }

    /* Toggle Switch */
    .toggle-switch { position: relative; display: inline-block; width: 50px; height: 26px; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--btn-bg); }
    input:checked + .slider:before { transform: translateX(24px); }

    /* Shredder */
    .shredder-wrapper { position: relative; overflow: hidden; padding-bottom: 20px; }
    .shredder-input { width: 90%; padding: 12px; border: 2px solid var(--card-border); border-radius: 10px; background: var(--bg-color); color: var(--text-main); position: relative; z-index: 2; }
    .shredder-input.shredding { transform: translateY(150%); opacity: 0; transition: transform 1.5s cubic-bezier(0.4, 0.0, 0.2, 1); }
    .paper-strip { position: absolute; top: 60px; width: 8px; height: 40px; background: var(--bg-color); border: 1px solid #ddd; z-index: 1; opacity: 0; }
    @keyframes stripFall { 0% { transform: translateY(0) rotate(0deg); opacity: 1; } 100% { transform: translateY(200px) rotate(var(--rot)); opacity: 0; } }

    /* Modal */
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,.6); display: none; align-items: center; justify-content: center; padding: 20px; z-index: 7000; }
    .modal.open { display: flex; }
    .modal-card { background: var(--modal-bg); max-width: 520px; width: 100%; border-radius: 20px; padding: 26px 22px; border: 1px solid var(--card-border); color: var(--text-main); }
    .bigtime { font-size: 2rem; font-weight: 800; margin: 10px 0; color: var(--heading-color); }
    
    /* Play Grid */
    .play-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .play-btn-lg { height: 80px; border-radius: 15px; font-size: 1rem; display: flex; align-items: center; justify-content: center; background: var(--card-bg); border: 2px solid var(--card-border); color: var(--text-main); box-shadow: 0 4px 10px var(--card-shadow); flex-direction: column; gap: 5px; }

    /* Slime, Launchpad, Pop It, Battery */
    .slime-blob { width: 100px; height: 100px; background: #ff7da5; border-radius: 50%; margin: 10px auto; animation: morph 3s infinite; cursor: pointer; }
    @keyframes morph { 0%, 100% { border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%; } 50% { border-radius: 50% 50% 33% 67% / 55% 27% 73% 45%; } }
    .launchpad-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; background: #222; padding: 10px; border-radius: 10px; }
    .pad-btn { height: 40px; background: #444; border-radius: 5px; transition: background 0.5s; }
    .pad-btn.lit { background: #00ffcc; box-shadow: 0 0 15px #00ffcc; transition: none; }
    .pop-it-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; }
    .pop-bubble { width: 40px; height: 40px; border-radius: 50%; border: none; box-shadow: 0 4px 0 rgba(0,0,0,0.2); cursor: pointer; transition: 0.1s; }
    .pop-bubble:active, .pop-bubble.popped { transform: translateY(4px); box-shadow: inset 0 3px 5px rgba(0,0,0,0.3); }
    .battery-container { width: 100%; height: 40px; border: 3px solid var(--text-main); border-radius: 10px; padding: 3px; position: relative; box-sizing: border-box; }
    .battery-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #ff9a9e 0%, #fecfef 99%); border-radius: 5px; }
/* =========================================
   NEW AESTHETIC UPGRADES (Bubbles, Fog, Stars)
   ========================================= */

/* 1. Iridescent Soap Bubbles */
.bubble-container {
  position: relative; width: 100%; height: 300px;
  overflow: hidden; border-radius: 15px; background: transparent;
}
/* UPDATED: VISIBLE SOAP BUBBLES */
    .soap-bubble {
      position: absolute; 
      border-radius: 50%;
      
      /* 1. Multi-color gradient so it's visible on white AND dark */
      background: radial-gradient(
        circle at 30% 30%, 
        rgba(255, 255, 255, 0.95) 5%,  /* Bright Highlight */
        rgba(255, 255, 255, 0.1) 20%, 
        rgba(255, 182, 193, 0.2) 50%,  /* Pink Tint */
        rgba(135, 206, 235, 0.2) 85%,  /* Blue Tint */
        rgba(255, 105, 180, 0.1) 100%
      );
      
      /* 2. Darker Pink Border for definition */
      border: 1px solid rgba(255, 105, 180, 0.4);
      
      /* 3. Inner Shadow for depth */
      box-shadow: inset 0 0 10px rgba(255, 105, 180, 0.3), 0 5px 15px rgba(0,0,0,0.05);
      
      cursor: pointer; 
      opacity: 0; 
      animation: floatBubble linear forwards;
      z-index: 10;
    }
.soap-bubble::after { /* Reflection */
  content: ''; position: absolute; top: 15%; left: 15%;
  width: 20%; height: 10%; border-radius: 50%;
  background: rgba(255, 255, 255, 0.8); transform: rotate(45deg);
}
@keyframes floatBubble {
  0% { bottom: -50px; opacity: 0; transform: translateX(0) scale(0.8); }
  10% { opacity: 1; }
  100% { bottom: 120%; opacity: 0; transform: translateX(var(--drift)) scale(1); }
}
.bubble-pop {
  position: absolute; width: 100%; height: 100%;
  background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, transparent 60%);
  opacity: 0; animation: popAnim 0.3s ease-out;
}
@keyframes popAnim { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(2); opacity: 0; } }

/* 2. Shooting Stars */
.shooting-star {
  position: fixed; top: 0; left: 0; width: 100px; height: 2px;
  background: linear-gradient(90deg, rgba(255,255,255,1), transparent);
  transform: rotate(-45deg); pointer-events: auto; cursor: pointer; z-index: -1;
  animation: shoot 2s linear forwards; opacity: 0;
}
.shooting-star::before {
  content: ''; position: absolute; top: 50%; left: 0; transform: translateY(-50%);
  width: 4px; height: 4px; background: #fff; border-radius: 50%; box-shadow: 0 0 10px #fff, 0 0 20px #ff00de;
}
@keyframes shoot {
  0% { transform: translate(var(--sx), var(--sy)) rotate(-45deg); opacity: 1; width: 0; }
  10% { width: 100px; }
  100% { transform: translate(var(--ex), var(--ey)) rotate(-45deg); opacity: 0; width: 0; }
}

/* 3. Ambient Fog */
.fog-layer {
  position: fixed; bottom: 0; left: 0; width: 200%; height: 30vh;
  background: linear-gradient(to top, rgba(255,255,255,0.2) 0%, transparent 100%);
  mask-image: linear-gradient(to right, transparent, black 20%, black 80%, transparent);
  -webkit-mask-image: linear-gradient(to right, transparent, black 20%, black 80%, transparent);
  animation: fogMove 60s linear infinite alternate; z-index: -2; pointer-events: none;
}
@keyframes fogMove { from { transform: translateX(0); } to { transform: translateX(-50%); } }

/* 4. Silk Ribbon Cursor */
#ribbon-canvas {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999;
}

/* =========================================
   NEW CSS: AUTH & REALTIME UI
   ========================================= */
#auth-overlay {
    position: fixed; inset: 0; z-index: 10000;
    background: rgba(255,255,255,0.4);
    backdrop-filter: blur(30px);
    -webkit-backdrop-filter: blur(30px);
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    transition: opacity 0.5s ease;
}
.auth-card {
    background: var(--card-bg); border: 2px solid var(--card-border);
    padding: 30px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    text-align: center;
}
.auth-btn-group { display: flex; gap: 20px; margin-top: 20px; }
.auth-btn { 
    width: 100px; height: 100px; border-radius: 50%; border: none; 
    font-size: 3rem; cursor: pointer; transition: transform 0.2s;
    background: rgba(255,255,255,0.5); border: 2px solid white;
}
.auth-btn:hover { transform: scale(1.1); background: white; }

/* Connection Status */
#connection-status {
    position: fixed; top: 15px; left: 15px; z-index: 10001;
    width: 12px; height: 12px; border-radius: 50%;
    background: red; border: 2px solid white;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    transition: background 0.3s;
}

/* Notes UI */
#newNoteArea {
    width: 100%; padding: 10px; border-radius: 10px; border: 1px solid var(--card-border);
    background: rgba(255,255,255,0.5); font-family: inherit; margin-bottom: 10px;
    box-sizing: border-box;
}
#notesList {
    margin-top: 20px; text-align: left; max-height: 300px; overflow-y: auto;
}
.note-item {
    background: rgba(255,255,255,0.6); padding: 10px; border-radius: 10px;
    margin-bottom: 8px; font-size: 0.9rem; animation: fadeIn 0.3s;
}
.note-meta { font-size: 0.7rem; opacity: 0.7; display: flex; justify-content: space-between; }

/* Magic Button Styles */
.magic-btn {
    background: linear-gradient(45deg, #a18cd1, #fbc2eb);
    color: white; border: none; padding: 10px 20px; border-radius: 50px;
    font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(161, 140, 209, 0.4);
    transition: transform 0.2s; margin-left: 5px;
}
.magic-btn:active { transform: scale(0.95); }
.magic-result {
    font-style: italic; color: var(--heading-color); margin-top: 10px; font-size: 0.9rem;
}
  </style>
</head>
<body>
<!-- CONNECTION DOT -->
<div id="connection-status" title="Disconnected"></div>

<!-- AUTH OVERLAY -->
<div id="auth-overlay">
    <div class="auth-card">
        <h1>Who are you? ü§î</h1>
        <p>Tap your character to enter!</p>
        <div class="auth-btn-group">
            <button class="auth-btn" data-user="Kitten" id="btn-kitten">üê±<div style="font-size:1rem;font-weight:bold;margin-top:5px;">Kitten</div></button>
            <button class="auth-btn" data-user="Daddy" id="btn-daddy">ü§µ<div style="font-size:1rem;font-weight:bold;margin-top:5px;">Daddy</div></button>
        </div>
    </div>
</div>

<div id="bokeh-container"></div>
<canvas id="ribbon-canvas"></canvas>
  <div id="star-container" style="position:fixed; inset:0; pointer-events:none; z-index:0;"></div>
  <div class="fog-layer" style="animation-duration: 40s;"></div>
  <div class="fog-layer" style="animation-duration: 30s; bottom: -50px; opacity: 0.7;"></div>
  <div id="rainContainer" class="rain-container"></div>

  <div id="tab-home" class="tab-section active">
    <!-- RESTORED: Local Image Path -->
    <div class="header-image">
      <img src="i-love-you.jpg" alt="I Love You" />
    </div>
    <h1 id="typingTitle">Our Countdowns ‚è≥</h1>

    <div class="countdowns">
      <div class="card" data-title="Our Anniversary üíû" data-date="09-06" data-note="Celebrating us üíå">
        <div class="event">Anniversary üíû</div>
        <div class="days"></div>
        <!-- RESTORED: Local Image Path -->
        <img class="card-img" src="your-anniversary-image.jpg" alt="Anniversary"/>
      </div>
      <div class="card" data-title="We meet!! üíû" data-absolute="2025-11-27T00:00:00" data-note="Together again üíñ">
        <div class="event">We meet!! ‚úàÔ∏è</div>
        <div class="days"></div>
        <!-- RESTORED: Local Image Path -->
        <img class="card-img" src="meeting.jpg" alt="Meeting"/>
      </div>
      <div class="card" data-title="End of Exams üìö" data-absolute="2025-12-30T23:59:59" data-note="Freedom! üå∑">
        <div class="event">Exams End üìö</div>
        <div class="days"></div>
        <!-- RESTORED: Local Image Path -->
        <img class="card-img" src="exam-end.jpg" alt="Exams"/>
      </div>
      <div class="card" data-title="Kitten‚Äôs Birthday üéÇ" data-date="01-02" data-note="Happy Birthday!">
        <div class="event">Kitten Bday üéÇ</div>
        <div class="days"></div>
        <!-- RESTORED: Local Image Path -->
        <img class="card-img" src="kitten-birthday.jpg" alt="Kitten Bday"/>
      </div>
      <div class="card" data-title="Daddy‚Äôs Birthday üéâ" data-date="04-14" data-note="Muah!">
        <div class="event">Daddy Bday üéâ</div>
        <div class="days"></div>
        <!-- RESTORED: Local Image Path -->
        <img class="card-img" src="daddy-birthday.jpg" alt="Daddy Bday"/>
      </div>
    </div>

    <!-- NEW LIVE CHAT (Mini) -->
    <div class="fun-card" style="margin-top: 20px; border-color: #a18cd1;">
        <h3 style="color: #a18cd1; margin-top:0;">Live Chat üí¨</h3>
        <div id="chat-messages">
            <div style="text-align:center; opacity:0.5; font-size:0.8rem;">No messages yet... say hi!</div>
        </div>
        <div class="chat-input-group">
            <input type="text" id="chatInput" placeholder="Type a message...">
            <button id="chatSendBtn" style="padding: 8px 15px;">‚û§</button>
        </div>
    </div>

    <h2>‚ú® Milestones ‚ú®</h2>
    <div class="countdowns">
       <div class="card" style="width: 90%; max-width: 400px;" onclick="toggleDetail('talk', '2025-04-22')">
          <h3>üí¨ First Talked</h3>
          <p id="talk-days">Loading...</p>
       </div>
       <div class="card" style="width: 90%; max-width: 400px;" onclick="toggleDetail('date', '2025-08-03')">
          <h3>üç∞ First Date</h3>
          <p id="date-days">Loading...</p>
       </div>
       <div class="card" style="width: 90%; max-width: 400px;" onclick="toggleDetail('love', '2025-08-28')">
          <h3>‚ù§Ô∏è Said "I Love You"</h3>
          <p id="love-days">Loading...</p>
       </div>
    </div>

    <!-- NEW GEMINI VIBE CHECKER -->
    <div class="fun-card" style="margin-top: 30px;">
        <h3>The Vibe Checker üîÆ</h3>
        <p style="font-size: 0.9rem; margin-bottom: 10px;">Check your partner's mood based on one word!</p>
        <div style="display:flex; gap:5px; justify-content:center;">
            <input type="text" id="vibeInput" placeholder="Enter a feeling (e.g., tired, excited)" style="width: 70%; padding: 8px; border-radius: 8px; border: 1px solid var(--card-border);">
            <button id="vibeCheckBtn" style="padding: 8px 15px; font-size: 0.9rem;">Analyze</button>
        </div>
        <div id="vibeOutput">...ready for analysis...</div>
    </div>
  </div>

  <div id="tab-notes" class="tab-section">
    <h1>Love Notes üíå</h1>
    
    <!-- NEW LIVE NOTES FEATURE + GEMINI -->
    <div class="fun-card" style="margin-bottom: 30px;">
        <h3>Send a Real Note üì®</h3>
        <textarea id="newNoteArea" rows="3" placeholder="Type a few words here (e.g. 'miss you')..."></textarea>
        <div style="display:flex; justify-content:center; gap:10px; margin-top:10px;">
            <button id="sendNoteBtn">Send üíò</button>
            <button id="magicDraftBtn" class="magic-btn">‚ú® Magic Draft</button>
        </div>
        <div id="notesList">
            <div style="text-align:center; opacity:0.6;">Loading notes...</div>
        </div>
    </div>

    <div class="card" style="width: 90%; max-width: 400px; margin: 0 auto 30px;" onclick="generateRandomNote()">
        <div class="event" style="font-size: 1.2rem;">üé≤ Random Note Generator</div>
        <div id="note-content" style="margin-top:10px; font-weight:bold;">Tap me!</div>
    </div>

    <div style="margin: 50px auto; perspective: 1000px; cursor: pointer; width: 280px; height: 180px;" onclick="this.classList.toggle('open')">
      <div class="envelope-container" style="position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d;">
        <div class="envelope-front" style="position: absolute; width: 100%; height: 100%; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-size: 3rem; backface-visibility: hidden; box-shadow: 0 10px 20px rgba(0,0,0,0.15);">
          üíå <div style="position: absolute; bottom: 10px; font-size: 0.9rem;">Tap to Open</div>
        </div>
        <div class="envelope-back" style="position: absolute; width: 100%; height: 100%; border: 2px solid; border-radius: 10px; transform: rotateY(180deg); padding: 20px; box-sizing: border-box; overflow-y: auto; text-align: left; display: flex; flex-direction: column; backface-visibility: hidden;">
          <h4 style="margin: 0 0 10px;">To my Khushi,</h4>
          <p style="font-size: 0.85rem; line-height: 1.4; margin: 0;">
            I know exams are tough, but you are tougher. I am so incredibly proud of you. Just remember to drink water and take breaks. I am always right here! <br><br> Love, Your Kitten.
          </p>
        </div>
      </div>
    </div>

    <h2>Open When...</h2>
    <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; padding: 0 10px;">
      <button onclick="alert('Everything will be okay. Take a deep breath. I believe in you! üåü')">You're Stressed üò∞</button>
      <button onclick="alert('I am so proud of you. You are working so hard and it shows! Keep going! üí™')">Need Motivation üò§</button>
      <button onclick="alert('Go look in the mirror. You are literally the prettiest girl ever. Don\'t argue. ü™û')">Feeling Insecure üò£</button>
    </div>

    <div class="fun-card" style="margin-top: 30px;">
        <h3>Daily To-Do (Synced) ‚úÖ</h3>
        <label style="display: block; margin: 5px 0;"><input type="checkbox" class="sync-todo" data-id="0"> call me </label>
        <label style="display: block; margin: 5px 0;"><input type="checkbox" class="sync-todo" data-id="1"> miss me ‚ù§Ô∏è</label>
        <label style="display: block; margin: 5px 0;"><input type="checkbox" class="sync-todo" data-id="2"> Drink water üíß</label>
    </div>
  </div>

  <div id="tab-play" class="tab-section">
    <h1>Play & Relax üß∏</h1>

    <div class="fun-card" style="display:flex; justify-content:space-between; align-items:center;">
        <span>üåô Dark Mode</span>
        <label class="toggle-switch"><input type="checkbox" id="themeToggle"><span class="slider"></span></label>
    </div>
    <div class="fun-card" style="display:flex; justify-content:space-between; align-items:center;">
        <span>üåßÔ∏è Rain Mode (Synced)</span>
        <label class="toggle-switch"><input type="checkbox" id="rainToggle"><span class="slider"></span></label>
    </div>
    
    <h3>‚ú® Aesthetic Modes ‚ú®</h3>
    <div class="play-grid">
      <div class="play-btn-lg" onclick="openGame('constellation')">üåå Stars</div>
      <div class="play-btn-lg" onclick="openGame('bloom')">üå∏ Bloom</div>
      <div class="play-btn-lg" onclick="openGame('lanterns')">üèÆ Lanterns</div>
      <div class="play-btn-lg" onclick="openGame('rain')">üåßÔ∏è Neon Rain</div>
    </div>

    <h3 style="margin-top: 30px;">Mini Games üéÆ</h3>
<div class="fun-card">
        <h3 style="color: var(--heading-color); margin-top:0;">Stress Bubbles ü´ß</h3>
        <p style="font-size:0.8rem;">Pop them before they float away!</p>
        <div class="bubble-container" id="soapBubbleContainer">
            </div>
    </div>
    <div class="fun-card">
      <h3>Jiggly Slime ü¶†</h3>
      <div class="slime-blob" onclick="pokeSlime(this)"></div>
    </div>
    <div class="fun-card">
      <h3>Rainbow Pop-It üåà</h3>
      <div class="pop-it-container" id="popItContainer"></div>
    </div>
    <div class="fun-card">
      <h3>Neon Launchpad üéõÔ∏è</h3>
      <div class="launchpad-grid" id="launchpad"></div>
    </div>
    <div class="fun-card">
        <h3>Worry Shredder üóëÔ∏è</h3>
        <div class="shredder-wrapper" id="shredderContainer">
          <textarea id="worryInput" class="shredder-input" rows="3" placeholder="Type worries here..."></textarea>
        </div>
        <button onclick="shredWorry(this)">Shred it! üí•</button>
    </div>
    <div class="fun-card">
      <h3>Love Battery üîã</h3>
      <div class="battery-container">
        <div class="battery-fill" id="batteryFill"></div>
      </div>
      <button id="chargeBtn" style="margin-top:10px;">Hold to Charge ‚ö°</button>
    </div>
    <div class="fun-card">
       <h3>Pet the Kitten üê±</h3>
       <div id="petZone" style="font-size: 5rem; cursor: grab;" onmousemove="petCat(event)" ontouchmove="petCat(event)">üê±</div>
       <p id="purrStatus">...</p>
    </div>
  </div>

  <div id="tab-comfort" class="tab-section">
    <h1>Comfort Zone üå∏</h1>
    <div class="comfort-header">
      <span><b>Period Comfort Mode</b><br>Warm colors & cozy vibes</span>
      <label class="toggle-switch">
        <input type="checkbox" id="periodModeToggle">
        <span class="slider"></span>
      </label>
    </div>
    <div class="fun-card">
      <h3>The Heat Pad ‚ô®Ô∏è</h3>
      <p>Hold the button to feel the warmth (vibration).</p>
      <button class="heat-pad-btn" id="heatPadBtn">HOLD ME</button>
    </div>
    <div class="fun-card">
      <h3>Emergency Chocolate üç´</h3>
      <p>Tap to take a bite!</p>
      <div class="choco-bar" id="chocoBar" onclick="eatChocolate()">
         <div class="choco-piece"></div><div class="choco-piece"></div><div class="choco-piece"></div><div class="choco-piece"></div>
         <div class="choco-piece"></div><div class="choco-piece"></div><div class="choco-piece"></div><div class="choco-piece"></div>
      </div>
      <p id="chocoMsg" style="min-height:20px; color:var(--accent-red); font-weight:bold;"></p>
    </div>
    <div class="fun-card" style="border-color: var(--accent-red);">
       <h3 style="color: var(--accent-red); margin-top: 0;">EMERGENCY üö®</h3>
       <!-- Updated Emergency Button Logic -->
       <a href="https://wa.me/7974776697?text=CODE%20RED!%20üö®%20Baby%20I%20need%20attention%20immediately!%20ü•∫" target="_blank" id="emergencyBtn" class="emergency-btn" style="background: var(--accent-red); color: white; display:block; padding:15px; text-decoration:none; border-radius:10px;">BREAK GLASS üî®</a>
    </div>
  </div>

  <div id="tab-gallery" class="tab-section" style="padding:0;">
      <h1 style="position:absolute; width:100%; top:10px; pointer-events:none; z-index:10;">Our Memories üì∏</h1>
      <p style="text-align:center; font-size:0.8rem;">Tap to turn pages!</p>
      <!-- NEW NOTEBOOK GALLERY CONTAINER -->
      <div id="gallery-container">
          <div class="book-scene">
              <div class="book" id="book">
                  <!-- Pages will be injected here by JS -->
              </div>
          </div>
      </div>
  </div>

  <nav class="nav-bar">
    <button class="nav-item active" onclick="switchTab('tab-home', this)">
      <span class="nav-icon">üè†</span><span class="nav-label">Home</span>
    </button>
    <button class="nav-item" onclick="switchTab('tab-notes', this)">
      <span class="nav-icon">üíå</span><span class="nav-label">Notes</span>
    </button>
    <button class="nav-item" onclick="switchTab('tab-play', this)">
      <span class="nav-icon">üß∏</span><span class="nav-label">Play</span>
    </button>
    <button class="nav-item" onclick="switchTab('tab-comfort', this)">
      <span class="nav-icon">üå∏</span><span class="nav-label">Comfort</span>
    </button>
    <button class="nav-item" onclick="switchTab('tab-gallery', this)">
      <span class="nav-icon">üì∏</span><span class="nav-label">Gallery</span>
    </button>
  </nav>

  <div id="game-constellation" class="game-overlay">
    <button class="overlay-close" onclick="closeGame()">√ó</button>
    <canvas id="constellationCanvas" class="fs-canvas"></canvas>
    <div style="position:absolute; bottom:20px; width:100%; text-align:center; color:rgba(255,255,255,0.5); pointer-events:none;">Tap to place stars</div>
  </div>
  
  <div id="game-bloom" class="game-overlay" style="background:#fff;">
    <button class="overlay-close" onclick="closeGame()" style="background:rgba(0,0,0,0.1); color:#333;">√ó</button>
    <canvas id="bloomCanvas" class="fs-canvas"></canvas>
    <div style="position:absolute; bottom:20px; width:100%; text-align:center; color:#888; pointer-events:none;">Tap to grow flowers</div>
  </div>

  <div id="game-lanterns" class="game-overlay" style="background: linear-gradient(to top, #0f2027, #203a43, #2c5364);">
    <button class="overlay-close" onclick="closeGame()">√ó</button>
    <div id="lanternContainer" style="width:100%; height:100%; position:relative;" onclick="spawnLantern(event)"></div>
    <div style="position:absolute; bottom:20px; width:100%; text-align:center; color:rgba(255,255,255,0.5); pointer-events:none;">Tap bottom to release lanterns</div>
  </div>

  <div id="game-rain" class="game-overlay" style="background: #000;">
    <button class="overlay-close" onclick="closeGame()">√ó</button>
    <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:#fff; font-size:3rem; font-weight:bold; z-index:1; pointer-events:none; text-shadow:0 0 20px #ff00de;">I Love You ‚ù§Ô∏è</div>
    <canvas id="rainCanvas" class="fs-canvas" style="z-index:2; position:relative;"></canvas>
    <div style="position:absolute; bottom:20px; width:100%; text-align:center; color:rgba(255,255,255,0.5); z-index:3; pointer-events:none;">Wipe the window...</div>
  </div>

  <div class="modal" id="modal">
    <div class="modal-card">
      <h3 id="modalTitle"></h3>
      <p id="modalNote"></p>
      <div class="bigtime" id="liveTime"></div>
      <button onclick="document.getElementById('modal').classList.remove('open')">Close</button>
    </div>
  </div>

  <!-- FIREBASE SDK (COMPAT LIBRARIES) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

  <script>
    /* =========================================
       FIREBASE CONFIGURATION
       ========================================= */
    const firebaseConfig = {
      apiKey: "AIzaSyBI2UJvRrGREZPh_zP85puaXrPc5BJXGXY",
      authDomain: "kittendaddy-94aaf.firebaseapp.com",
      projectId: "kittendaddy-94aaf",
      storageBucket: "kittendaddy-94aaf.firebasestorage.app",
      messagingSenderId: "890387974672",
      appId: "1:890387974672:web:e493660d1115ebb5b19895"
    };
    
    // =========================================
    // GEMINI API KEY (REQUIRED FOR MAGIC)
    // =========================================
    const geminiApiKey = "AIzaSyDVDto9WbxGX8bA0ks8AL209l2xY0US9d0"; 

    // --- GLOBAL STATE ---
    let currentUser = localStorage.getItem('kd_user');
    let actualGeminiKey = geminiApiKey;

    // --- MAIN APP ENTRY POINT ---
    window.onload = function() {
        // Find elements here once the DOM is ready
        const authOverlay = document.getElementById('auth-overlay');
        const connStatus = document.getElementById('connection-status');
        const themeToggle = document.getElementById('themeToggle');
        
        // Load Dark Mode Preference
        if(localStorage.getItem('theme') === 'dark') {
            themeToggle.checked = true;
            document.body.setAttribute('data-theme', 'dark');
        }

        themeToggle.addEventListener('change', (e) => {
            if(e.target.checked) document.body.setAttribute('data-theme', 'dark');
            else document.body.removeAttribute('data-theme');
        });
        
        // Restored Logic: Countdowns & Milestone Days
        function toggleDetail(id, dateStr) {
            const el = document.getElementById(id+'-days');
            if(!el) return;
            const start = new Date(dateStr);
            const diff = new Date() - start;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            el.innerText = el.innerText.includes('days') ? `${days}d ${Math.floor((diff/(1000*60*60))%24)}h` : `${days} days üí´`;
        }
        // Attach globally for onclick in HTML
        window.toggleDetail = toggleDetail; 
        
        // Initialize milestone text
        toggleDetail('talk', '2025-04-22'); toggleDetail('date', '2025-08-03'); toggleDetail('love', '2025-08-28');
        
        // Calculate Countdown Cards
        document.querySelectorAll('.card[data-date], .card[data-absolute]').forEach(card => {
            let target;
            if(card.dataset.absolute) target = new Date(card.dataset.absolute);
            else {
                 const [m, d] = card.dataset.date.split('-').map(Number);
                 const now = new Date();
                 target = new Date(now.getFullYear(), m - 1, d);
                 if (target < now) target.setFullYear(now.getFullYear() + 1);
            }
            const diff = target - new Date();
            const days = Math.ceil(diff / (1000 * 60 * 60 * 24));
            const daysEl = card.querySelector('.days');
            if(daysEl) daysEl.innerText = days > 0 ? `${days} days` : 'Today!';
            
            // Attach Modal Listener
            card.addEventListener('click', () => openModal(card));
        });


        // 1. Check if Firebase config is set up
        if(firebaseConfig.apiKey && firebaseConfig.apiKey !== "FIREBASE_API_KEY_PLACEHOLDER") {
            
            // --- FIREBASE INITIALIZATION AND AUTH ---
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const auth = firebase.auth();

            // Anonymous Sign-in (Required for read/write access under open rules)
            auth.signInAnonymously()
                .then(() => {
                    console.log('Signed in anonymously');
                    connStatus.style.background = '#48bb78'; // Green
                    connStatus.title = 'Connected';
                })
                .catch((error) => {
                    console.error('Sign in failed', error);
                    connStatus.style.background = 'red';
                    connStatus.title = 'Connection Failed: Check Firebase Rules & Config';
                });
            
            // --- ATTACH MULTIPLAYER LISTENERS (Only if Firebase is initialized) ---
            attachMultiplayerListeners(db, connStatus);


        } else {
            console.warn("Firebase Config Missing. Multiplayer features disabled.");
            connStatus.title = "Offline: Missing Firebase Keys";
        }
        
        // 2. Character Selection Logic
        function setIdentity(id) {
            currentUser = id;
            localStorage.setItem('kd_user', id);
            authOverlay.style.opacity = '0';
            setTimeout(() => authOverlay.style.display = 'none', 300);
            document.title = `${id}'s View üíñ`;
        }
        
        document.querySelectorAll('.auth-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const userId = e.currentTarget.dataset.user;
                setIdentity(userId);
            });
        });

        if(!currentUser) {
            authOverlay.style.display = 'flex'; // Force show the overlay if no user is saved
        }
        
        // --- DEFINE MULTIPLAYER FUNCTIONS ---

        function attachMultiplayerListeners(db) {
            
            // 3. Realtime Rain Toggle
            const rainToggleBtn = document.getElementById('rainToggle');
            db.collection('app').doc('sharedState').onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    if (data.rainActive !== rainToggleBtn.checked) {
                        rainToggleBtn.checked = data.rainActive;
                        toggleRainEffect(data.rainActive);
                    }
                    if(data.emergency && data.emergency > Date.now() - 10000 && data.sender !== currentUser) {
                         if(sessionStorage.getItem('lastAlert') != data.emergency) {
                             sessionStorage.setItem('lastAlert', data.emergency);
                             if(navigator.vibrate) navigator.vibrate([500, 200, 500, 200, 1000]);
                             alert("üö® EMERGENCY! üö®\n\nYour partner pressed the Break Glass button!\nThey need attention immediately! ‚ù§Ô∏è");
                         }
                    }
                }
            });

            rainToggleBtn.addEventListener('change', (e) => {
                toggleRainEffect(e.target.checked);
                db.collection('app').doc('sharedState').set({ rainActive: e.target.checked }, { merge: true });
            });

            // 4. Sync To-Dos
            const checkboxes = document.querySelectorAll('.sync-todo');
            db.collection('app').doc('todos').onSnapshot((doc) => {
                const data = doc.data() || {};
                checkboxes.forEach(box => {
                    const id = box.dataset.id;
                    if(data[id] !== undefined) box.checked = data[id];
                });
            });

            checkboxes.forEach(box => {
                box.addEventListener('change', (e) => {
                    const id = e.target.dataset.id;
                    db.collection('app').doc('todos').set({ [id]: e.target.checked }, { merge: true });
                });
            });

            // 5. Emergency Trigger
            document.getElementById('emergencyBtn').addEventListener('click', () => {
                 if(!currentUser) return alert("Select character first!");
                 db.collection('app').doc('sharedState').set({ emergency: Date.now(), sender: currentUser }, { merge: true });
            });

            // 6. Live Notes
            const sendNoteBtn = document.getElementById('sendNoteBtn');
            const noteInput = document.getElementById('newNoteArea');
            const notesList = document.getElementById('notesList');

            sendNoteBtn.addEventListener('click', () => {
                const txt = noteInput.value.trim();
                if(!txt) return alert("Please write a note before sending.");
                if(!currentUser) return alert("Please select your character (Kitten/Daddy) first!");
                db.collection('loveNotes').add({ text: txt, sender: currentUser || "Anonymous", timestamp: Date.now() })
                .then(() => { noteInput.value = ''; sendNoteBtn.innerText = "Sent! üì®"; setTimeout(() => sendNoteBtn.innerText = "Send üíò", 2000); })
                .catch((error) => { console.error("Error sending note: ", error); alert("Failed to send note. Check Firebase Rules."); });
            });

            db.collection('loveNotes').orderBy('timestamp', 'desc').limit(20).onSnapshot(snapshot => {
                notesList.innerHTML = '';
                snapshot.forEach(doc => {
                    const note = doc.data();
                    const div = document.createElement('div');
                    div.className = 'note-item';
                    div.innerHTML = `<div class="note-meta"><span>${note.sender}</span><span>${new Date(note.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span></div><div style="margin-top:5px;">${note.text}</div>`;
                    notesList.appendChild(div);
                });
            });

            // 7. LIVE CHAT LOGIC
            const chatInput = document.getElementById('chatInput');
            const chatSendBtn = document.getElementById('chatSendBtn');
            const chatContainer = document.getElementById('chat-messages');

            function sendMessage() {
                const txt = chatInput.value.trim();
                if(!txt) return;
                if(!currentUser) return alert("Please select your character (Kitten/Daddy) to start chatting!");
                db.collection('liveChat').add({ text: txt, sender: currentUser, timestamp: Date.now() })
                .catch((error) => { console.error("Error sending chat: ", error); alert("Chat message failed to send."); });
                chatInput.value = '';
            }

            chatSendBtn.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') sendMessage();
            });

            // Removed .orderBy('timestamp', 'asc') to prevent index errors if not set up.
            // Standard fetch is fine for small chats, client can sort if needed, but usually default is insert order or close enough.
            // For better robustness without manual index creation, we'll use basic snapshot.
            // If you add an index in Firebase console, you can add .orderBy('timestamp') back.
            db.collection('liveChat').limit(50).onSnapshot(snapshot => {
                const messages = [];
                snapshot.forEach(doc => messages.push(doc.data()));
                // Sort in memory to avoid index requirement
                messages.sort((a, b) => a.timestamp - b.timestamp);
                
                chatContainer.innerHTML = '';
                messages.forEach(msg => {
                    const div = document.createElement('div');
                    div.className = 'chat-msg ' + (msg.sender === currentUser ? 'msg-self' : 'msg-other');
                    div.textContent = msg.text;
                    chatContainer.appendChild(div);
                });
                chatContainer.scrollTop = chatContainer.scrollHeight;
            });
        }
        
    }; // End of window.onload

    /* =========================================
       GEMINI API HELPER FUNCTION
       ========================================= */
    async function callGemini(promptText) {
        if (!actualGeminiKey || actualGeminiKey.includes("PLACEHOLDER") || actualGeminiKey.length < 30) {
            alert("ü™Ñ GEMINI KEY MISSING: Please ensure a valid API key is available.");
            return null;
        }
        
        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${actualGeminiKey}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ contents: [{ parts: [{ text: promptText }] }] })
            });
            const data = await response.json();
            if(data.error) throw new Error(data.error.message);
            return data.candidates[0].content.parts[0].text;
        } catch (e) {
            console.error("Gemini Spell Failed:", e);
            return null;
        }
    }

    /* =========================================
       GEMINI FEATURE 1: MAGIC NOTE DRAFTER
       ========================================= */
    document.getElementById('magicDraftBtn').addEventListener('click', async function() {
        const input = document.getElementById('newNoteArea');
        const context = input.value.trim() || "I love you";
        
        this.innerText = "Conjuring... ü™Ñ";
        
        const partnerName = (currentUser === 'Kitten' ? 'Daddy' : 'Kitten');
        const prompt = `Write a short, very romantic, cute, and heartfelt love note (max 2 sentences) for my partner, ${partnerName}. 
        Context/Mood: ${context}. 
        Use 2-3 relevant emojis. Do not use quotes around the output.`;
        
        const result = await callGemini(prompt);
        
        if(result) {
            input.value = result;
        }
        this.innerText = "‚ú® Magic Draft";
    });

    /* =========================================
       GEMINI FEATURE 2: VIBE CHECKER
       ========================================= */
    document.getElementById('vibeCheckBtn').addEventListener('click', async function() {
        const vibeInput = document.getElementById('vibeInput');
        const vibeOutput = document.getElementById('vibeOutput');
        const feeling = vibeInput.value.trim();

        if (!feeling) {
            vibeOutput.innerHTML = "Please enter a feeling to analyze!";
            return;
        }

        this.innerText = "Analyzing... üîç";
        vibeOutput.style.opacity = 0.5;

        const partner = (currentUser === 'Kitten' ? 'Daddy' : 'Kitten');
        const self = currentUser;
        
        const prompt = `Act as a supportive relationship AI. ${self} reports that their partner, ${partner}, is feeling the following emotion: "${feeling}". Analyze the emotion and provide a one-paragraph, concise, caring 'Partner Status Report' and a simple, immediate suggestion for what ${self} should do next to support ${partner}. Use cute emojis.`;

        const result = await callGemini(prompt);

        if (result) {
            vibeOutput.innerHTML = result;
        } else {
            vibeOutput.innerHTML = "Analysis failed. Try a different word!";
        }

        vibeOutput.style.opacity = 1;
        this.innerText = "Analyze";
    });


    /* =========================================
       STANDARD APP FUNCTIONS (Outside Firebase Init)
       ========================================= */
       
    // 1. Navigation System
    function switchTab(tabId, btn) {
        document.querySelectorAll('.tab-section').forEach(t => t.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        window.scrollTo(0,0);
        // Init gallery only if needed
        if(tabId === 'tab-gallery') initGallery();
    }
    window.switchTab = switchTab; // Make global

    // 2. Toggles & Modes
    const rainCont = document.getElementById('rainContainer');
    let rainInt;
    function toggleRainEffect(isActive) {
        if(isActive) {
            rainCont.classList.add('active');
            if(!rainInt) { 
                rainInt = setInterval(() => {
                    const drop = document.createElement('div');
                    drop.className = 'rain-drop';
                    drop.style.left = Math.random() * 100 + 'vw';
                    drop.style.animationDuration = (0.5 + Math.random()) + 's';
                    rainCont.appendChild(drop);
                    setTimeout(() => drop.remove(), 2000);
                }, 50);
            }
        } else {
            rainCont.classList.remove('active');
            clearInterval(rainInt);
            rainInt = null;
            rainCont.innerHTML = '';
        }
    }

    const periodToggle = document.getElementById('periodModeToggle');
    periodToggle.addEventListener('change', (e) => {
        const themeToggle = document.getElementById('themeToggle'); 
        if(e.target.checked) document.body.setAttribute('data-theme', 'comfort');
        else {
             if(themeToggle.checked) document.body.setAttribute('data-theme', 'dark');
             else document.body.removeAttribute('data-theme');
        }
    });

    // 3. Floating Hearts
    function createFloatingHeart() {
        const h = document.createElement('div');
        h.innerText = ['üíñ', '‚ú®'][Math.floor(Math.random() * 2)];
        h.className = 'heart-bg';
        h.style.position = 'fixed';
        h.style.left = Math.random() * 100 + 'vw';
        h.style.bottom = '-50px';
        const size = Math.random() * 15 + 10; 
        h.style.fontSize = size + 'px';
        h.style.opacity = Math.random() * 0.5 + 0.3; 
        h.style.zIndex = '-1'; 
        h.style.pointerEvents = 'none';
        h.style.transition = `transform ${Math.random() * 5 + 5}s linear, opacity 5s ease`;
        
        document.body.appendChild(h);
        
        requestAnimationFrame(() => {
            h.style.transform = `translateY(-110vh) rotate(${Math.random() * 360}deg)`;
            h.style.opacity = '0';
        });

        setTimeout(() => h.remove(), 10000);
    }
    setInterval(createFloatingHeart, 800);

    /* --- Mini Games Logic --- */
    function shredWorry(btn) {
       const input = document.getElementById('worryInput');
       const container = document.getElementById('shredderContainer');
       if(!input.value.trim()) return alert("Write something first!");
       input.classList.add('shredding');
       for(let i=0; i<20; i++) {
           const strip = document.createElement('div');
           strip.className = 'paper-strip';
           strip.style.left = Math.random()*90+'%';
           strip.style.setProperty('--rot', Math.random()*360+'deg');
           strip.style.animation = `stripFall ${1+Math.random()}s forwards`;
           container.appendChild(strip);
           setTimeout(()=>strip.remove(), 2000);
       }
       setTimeout(() => { input.value=''; input.classList.remove('shredding'); }, 2000);
    }
    function petCat(e) {
       const cat = document.getElementById('petZone');
       cat.style.transform = `scale(1.1) rotate(${Math.random()*20-10}deg)`;
       document.getElementById('purrStatus').innerText = ["Purr...", "Meow!", "‚ù§Ô∏è"][Math.floor(Math.random()*3)];
       setTimeout(()=>cat.style.transform='scale(1)', 100);
    }
    const heatBtn = document.getElementById('heatPadBtn');
    let vibrateInterval;
    const startHeat = (e) => { e.preventDefault(); heatBtn.classList.add('active'); if(navigator.vibrate) vibrateInterval = setInterval(() => navigator.vibrate(200), 250); };
    const stopHeat = () => { heatBtn.classList.remove('active'); if(vibrateInterval) clearInterval(vibrateInterval); if(navigator.vibrate) navigator.vibrate(0); };
    heatBtn.addEventListener('mousedown', startHeat); heatBtn.addEventListener('touchstart', startHeat); heatBtn.addEventListener('mouseup', stopHeat); heatBtn.addEventListener('touchend', stopHeat);
    
    /* -----------------------------------------
       NEW GALLERY LOGIC: NOTEBOOK / FLIPBOOK
       ----------------------------------------- */
    const imageFiles = ['your-anniversary-image.jpg', 'meeting.jpg', 'kitten-birthday.jpg', 'daddy-birthday.jpg', 'exam-end.jpg', 'images/image.jpg'];
    for(let i=1; i<=10; i++) imageFiles.push(`images/image${i}.jpg`);
    
    let galleryInit = false;
    
    function initGallery() {
        if(galleryInit) return;
        galleryInit = true;
        
        const book = document.getElementById('book');
        if(!book) return;

        // Cover Page
        const coverPage = document.createElement('div');
        coverPage.className = 'page';
        coverPage.style.zIndex = imageFiles.length + 2;
        
        const coverFront = document.createElement('div');
        coverFront.className = 'page-face';
        coverFront.innerHTML = `<h2 style="color:#ff5e89; font-size:2rem;">Our Memories</h2><div style="font-size:3rem;">üìî</div><p style="margin-top:20px; color:#888;">Tap to open</p>`;
        
        const coverBack = document.createElement('div');
        coverBack.className = 'page-face page-back';
        coverBack.innerHTML = `<p>Enjoy the trip down memory lane... ‚ù§Ô∏è</p>`; // Left side of open book
        
        coverPage.appendChild(coverFront);
        coverPage.appendChild(coverBack);
        
        // Click logic for cover
        coverPage.onclick = function() {
            if(this.classList.contains('flipped')) {
                this.classList.remove('flipped');
                this.style.zIndex = imageFiles.length + 2;
            } else {
                this.classList.add('flipped');
                this.style.zIndex = 1; // Move to bottom of left stack
            }
        };
        book.appendChild(coverPage);

        // Create Pages for Images
        // We will put one image per page (on the front face). 
        // When you flip page 1, you see its back (blank or pattern) on left, and Page 2 front on right.
        imageFiles.forEach((src, index) => {
            const page = document.createElement('div');
            page.className = 'page';
            // Stack order: higher index = lower in stack? No, first page is on top.
            // We need z-index to be high for early pages.
            let zIndexVal = imageFiles.length - index + 1; 
            page.style.zIndex = zIndexVal;
            
            // Front Face (Photo)
            const front = document.createElement('div');
            front.className = 'page-face';
            front.innerHTML = `
                <div class="photo-frame">
                    <img src="${src}" loading="lazy" alt="Memory ${index+1}">
                </div>
                <div class="page-number">Page ${index+1}</div>
            `;
            
            // Back Face (Simple pattern or quote)
            const back = document.createElement('div');
            back.className = 'page-face page-back';
            back.style.background = '#fdfdfd';
            back.innerHTML = `<div style="font-size:2rem; opacity:0.1;">üíñ</div>`;

            page.appendChild(front);
            page.appendChild(back);
            
            // Flip Logic
            page.onclick = function() {
                if (this.classList.contains('flipped')) {
                    // FLIP BACK (Left to Right)
                    this.classList.remove('flipped');
                    // Restore Z-Index so it sits on top of the right stack
                    // We need a slight delay or just set it immediately? 
                    // If we set it immediately, it might clip through pages underneath during anim.
                    // Usually better to set z-index after transition for correct stacking.
                    // But for simplicity:
                    setTimeout(() => { this.style.zIndex = zIndexVal; }, 400); 
                } else {
                    // FLIP FORWARD (Right to Left)
                    this.classList.add('flipped');
                    // It goes to the top of the LEFT stack.
                    // Z-index behavior: The "latest" flipped page should be on top of left stack.
                    // Since this page has higher natural zIndexVal than the next page, 
                    // when it flips, it naturally covers the previous flipped pages if we don't change z-index? 
                    // Actually, standard HTML stacking: later elements in DOM are on top.
                    // Here, earlier elements are on top of right stack (via custom z-index).
                    // We need to manage this carefully.
                    // Simple hack: When flipped, give it a high z-index based on order?
                    this.style.zIndex = 100 + index; 
                }
            };
            
            book.appendChild(page);
        });
    }
    
    /* ... other game functions ... */
    /* Truncated for brevity, but preserved in functionality */
    const popContainer = document.getElementById('popItContainer');
    const popColors = ['#ff7da5', '#ffca85', '#fbfb96', '#baffc9', '#bae1ff'];
    for(let i=0; i<12; i++) {
        const b = document.createElement('button');
        b.className = 'pop-bubble';
        b.style.background = popColors[i%5];
        b.onclick = () => { b.classList.toggle('popped'); if(navigator.vibrate) navigator.vibrate(5); };
        popContainer.appendChild(b);
    }
    const lp = document.getElementById('launchpad');
    for(let i=0; i<12; i++) {
        const d = document.createElement('div');
        d.className = 'pad-btn';
        d.onmouseover = d.ontouchstart = () => { d.classList.add('lit'); setTimeout(()=>d.classList.remove('lit'), 200); };
        lp.appendChild(d);
    }
    function pokeSlime(el) {
        el.style.transform = `scale(0.9) rotate(${Math.random()*20-10}deg)`;
        setTimeout(() => el.style.transform = 'scale(1)', 200);
    }
    let renderLoop;
    function openGame(id) {
        document.getElementById('game-'+id).classList.add('active');
        if(id === 'constellation') initConstellation();
        if(id === 'bloom') initBloom();
        if(id === 'rain') initRain();
    }
    window.closeGame = function() {
        document.querySelectorAll('.game-overlay').forEach(el => el.classList.remove('active'));
        if(renderLoop) cancelAnimationFrame(renderLoop);
    }
    window.openGame = openGame; 
    function initConstellation() {
        const c = document.getElementById('constellationCanvas');
        c.width = window.innerWidth; c.height = window.innerHeight;
        const ctx = c.getContext('2d');
        let stars = [];
        c.onclick = (e) => {
            const rect = c.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            ctx.fillStyle = "white"; ctx.shadowBlur = 10; ctx.shadowColor = "white";
            ctx.beginPath(); ctx.arc(x, y, 3, 0, Math.PI*2); ctx.fill();
            if(stars.length > 0) {
                const prev = stars[stars.length-1];
                ctx.strokeStyle = "rgba(255,255,255,0.4)"; ctx.lineWidth = 1;
                ctx.beginPath(); ctx.moveTo(prev.x, prev.y); ctx.lineTo(x, y); ctx.stroke();
            }
            stars.push({x, y});
        }
    }
    function initBloom() {
        const c = document.getElementById('bloomCanvas');
        c.width = window.innerWidth; c.height = window.innerHeight;
        const ctx = c.getContext('2d');
        const flowers = [];
        function drawFlower(x, y, size, hue, alpha) {
            ctx.save(); ctx.translate(x, y); ctx.fillStyle = `hsla(${hue}, 70%, 70%, ${alpha})`;
            ctx.shadowBlur = 15; ctx.shadowColor = `hsla(${hue}, 70%, 50%, 0.5)`;
            for(let i=0; i<6; i++) { ctx.beginPath(); ctx.rotate(Math.PI / 3); ctx.ellipse(0, -size/2, size/4, size/2, 0, 0, Math.PI*2); ctx.fill(); }
            ctx.beginPath(); ctx.arc(0, 0, size/4, 0, Math.PI*2); ctx.fillStyle = "#fff"; ctx.fill(); ctx.restore();
        }
        c.onclick = (e) => {
            const rect = c.getBoundingClientRect();
            flowers.push({x: e.clientX - rect.left, y: e.clientY - rect.top, size: 0, targetSize: 30 + Math.random() * 40, hue: Math.random() * 360, growing: true});
        };
        function loop() {
            ctx.clearRect(0,0,c.width,c.height);
            flowers.forEach(f => {
                if(f.growing) { f.size += 2; if(f.size >= f.targetSize) f.growing = false; }
                drawFlower(f.x, f.y, f.size, f.hue, 0.8);
            });
            renderLoop = requestAnimationFrame(loop);
        }
        loop();
    }

  </script>
</body>
</html>
